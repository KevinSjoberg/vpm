#!/bin/sh
version="0.0.1"
log_dir="$HOME/.vpmlog"
plugin_dir="$HOME/.vim/bundle"
plugin_spec="$HOME/.vimplugins"

# command helpers
#
function empty {
  [ -z "$1" ]
}

function success {
  echo "success: $1"
}

function failure {
  echo "failure: $1"
}

function success_and_exit {
  success "$1"
  exit 0
}

function failure_and_exit {
  failure "$1"
  exit 1
}

function plugin_insert {
  local plugin=$1
  local plugin_repository="git@github.com:$plugin.git"

  cd $plugin_dir
  git clone $plugin_repository >> $log_dir 2>&1
}

function plugin_remove {
  local plugin_name=$1

  cd $plugin_dir
  rm -rf $plugin_name
}

function plugin_update {
  local plugin_path=$1

  cd $plugin_path
  git pull origin master >> $log_dir 2>&1
}

function plugin_inserted {
  local plugin_name=$1

  [ -d $plugin_dir/$plugin_name ]
}

# command functions
#
function help() {
cat <<-HELP
Usage:
  vpm [OPTION] [PLUGIN]

Commands:

  Help:
    vpm
    vpm -h
    vpm --help

  List:
    vpm -l
    vpm --list

  Insert:
    vpm          PLUGIN
    vpm -i       PLUGIN
    vpm --insert PLUGIN

  Remove:
    vpm -r       PLUGIN
    vpm --remove PLUGIN

  Update:
    vpm -u       [PLUGIN]
    vpm --update [PLUGIN]

  Version:
    vpm -v
    vpm --version

  Snapshot:
    vpm -s
    vpm --snapshot

  Bootstrap:
    vpm -b
    vpm --bootstrap
HELP
}

function list {
  unset CLICOLOR && ls $plugin_dir
}

function insert {
  local plugin=$1
  local plugin_name=$(basename $plugin)

  if empty $plugin_name; then
    help
  fi

  if plugin_inserted $plugin_name; then
    failure_and_exit "$plugin_name already inserted"
  fi

  if plugin_insert $plugin; then
    success_and_exit "$plugin_name inserted"
  else
    failure_and_exit "$plugin_name could not be inserted"
  fi
}

function remove {
  local plugin_name=$1

  if empty $plugin_name; then
    help
  fi

  if plugin_inserted $plugin_name; then
    plugin_remove $plugin_name
    success_and_exit "$plugin_name removed"
  else
    failure_and_exit "$plugin_name not inserted"
  fi
}

function update {
  for plugin_path in $(find $plugin_dir -iname "${1-*}" -mindepth 1 -maxdepth 1 -type d); do
    local plugin_name=$(basename $plugin_path)

    if plugin_update $plugin_path; then
      success "$plugin_name updated"
    else
      failure "$plugin_name could not be updated"
    fi
  done
}

function version {
  echo $version
}

function snapshot {
  list > $plugin_spec
  success_and_exit "snapshot taken from installed plugins"
}

function bootstrap {
  failure_and_exit "Not implemented"
}

# Main
#
case $1 in
  "-h"|"--help")
    help
    ;;
  "-l"|"--list")
    list
    ;;
  "-i"|"--insert")
    insert $2
    ;;
  "-r"|"--remove")
    remove $2
    ;;
  "-u"|"--update")
    update $2
    ;;
  "-v"|"--version")
    version
    ;;
  "-s"|"--snapshot")
    snapshot
    ;;
  "-b"|"--bootstrap")
    bootstrap
    ;;
  "")
    help
    ;;
  *)
    insert $1
    ;;
esac
